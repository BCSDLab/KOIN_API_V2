name: Flyway Dangerous SQL Validator
# ë¸”ë£¨/ê·¸ë¦° ë°°í¬ í™˜ê²½ì—ì„œ ê¸°ì¡´ WASì™€ DBì˜ ìŠ¤í‚¤ë§ˆ ë¶ˆì¼ì¹˜í•˜ëŠ” ì˜¤ë¥˜ë¥¼ ë°©ì§€í•œë‹¤.

on:
  pull_request:
    paths:
      - "**"

jobs:
  check-flyway-dangerous-sql:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Validate Dangerous SQL and Non-Flyway Changes
        run: |
          BASE=${{ github.event.pull_request.base.sha }}
          HEAD=${{ github.event.pull_request.head.sha }}

          CHANGED_FILES=$(git diff --name-only "$BASE" "$HEAD")

          NON_FLYWAY_FILES_CHANGES=$(echo "$CHANGED_FILES" \
            | grep -v '^src/main/resources/db/migration/' || true)

          echo "ğŸ” ë³€ê²½ëœ Flyway SQL íŒŒì¼ ê²€ì‚¬ ì¤‘..."

          DANGEROUS_FOUND=0

          for file in $(git diff --name-only "$BASE" "$HEAD" -- src/main/resources/db/migration/*.sql); do
            ADDED_SQL=$(git diff "$BASE" "$HEAD" -- "$file" \
              | grep -i -wE "^\+.*\b(DROP|TRUNCATE|RENAME|CHANGE)\b" || true)

            if [[ -n "$ADDED_SQL" ]]; then
              echo "::error::âš ï¸ ìœ„í—˜ SQL ê°ì§€ë¨"
              echo "íŒŒì¼: $file"
              echo "$ADDED_SQL" | sed 's/^/    /'
              DANGEROUS_FOUND=1
            fi
          done

          if [[ "$DANGEROUS_FOUND" -eq 1 && -n "$NON_FLYWAY_FILES_CHANGES" ]]; then
            echo ""
            echo "::error::ë¸”ë£¨ê·¸ë¦° ë°°í¬ì—ì„œ ìŠ¤í‚¤ë§ˆ ì¶©ëŒë¡œ ì¸í•´ ì„œë²„ ì•ˆì •ì„±ì„ ë³´ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi

